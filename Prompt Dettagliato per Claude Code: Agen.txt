Prompt Dettagliato per Claude Code: Agente di Trading AI
# AGENTE DI TRADING AI CON PYTHON - SPECIFICHE COMPLETE

Crea un agente di trading AI completo per operare autonomamente su Hyperliquid exchange utilizzando un Large Language Model come cervello decisionale.

## OBIETTIVO GENERALE
Sviluppare un sistema di trading automatizzato che:
- Si sveglia ogni 15 minuti
- Raccoglie dati di mercato, indicatori tecnici e sentiment
- Utilizza un LLM (deepseek di cui hai la api nel env
- Esegue operazioni di trading su BTC, ETH e SOL
- Gestisce il rischio con stop loss e take profit
- Logga tutte le operazioni in database PostgreSQL
- Fornisce una dashboard per monitoraggio real-time

---

## ARCHITETTURA E STACK TECNOLOGICO

### Linguaggi e Framework
- **Python 3.10+** come linguaggio principale
- **CCXT** per interazione con exchange (NON usare SDK Python di Hyperliquid)
- **Anthropic API** per il Large Language Model decisionale
- **PostgreSQL** come database relazionale
- **Prophet (Meta)** per forecasting dei prezzi
- **Streamlit** per dashboard di monitoraggio
- **SQLAlchemy** per ORM database
- **Pandas/NumPy** per calcoli indicatori
- **Railway** per deployment come cron job

### Struttura Directory Completa
trading-agent/
├── main.py                      # Entry point principale
├── requirements.txt             # Dipendenze Python
├── .env.example                 # Template variabili ambiente
├── README.md                    # Documentazione
├── railway.json                 # Configurazione Railway cron
├── Dockerfile                   # (Opzionale) Container
│
├── config/
│   ├── init.py
│   ├── settings.py             # Configurazioni da variabili ambiente
│   ├── prompts.py              # System prompt e template per LLM
│   └── constants.py            # Costanti del sistema
│
├── core/
│   ├── init.py
│   ├── agent.py                # Orchestrazione logica principale
│   ├── llm_client.py           # Client Anthropic API
│   ├── risk_manager.py         # Gestione rischio e capitale
│   └── decision_validator.py   # Validazione decisioni LLM
│
├── exchange/
│   ├── init.py
│   ├── hyperliquid_client.py  # Wrapper CCXT per Hyperliquid
│   ├── order_manager.py       # Gestione ordini e posizioni
│   └── portfolio.py           # Gestione portfolio e bilanci
│
├── indicators/
│   ├── init.py
│   ├── technical.py           # MACD, RSI, EMA (indicatori classici)
│   ├── pivot_points.py        # Calcolo pivot points (R1, R2, S1, S2, PP)
│   ├── forecasting.py         # Modello Prophet per previsioni
│   └── weights.py             # Sistema pesi importanza indicatori
│
├── data/
│   ├── init.py
│   ├── market_data.py         # Raccolta dati storici/real-time
│   ├── sentiment.py           # Sentiment da CoinMarketCap
│   ├── news_feed.py           # Parser XML feed notizie
│   ├── whale_alert.py         # (Opzionale) Monitoraggio whale
│   └── cache_manager.py       # Cache per evitare rate limits
│
├── database/
│   ├── init.py
│   ├── models.py              # SQLAlchemy models
│   ├── connection.py          # Setup connessione DB
│   ├── operations.py          # CRUD operations
│   └── migrations/            # Alembic migrations
│       └── versions/
│
├── dashboard/
│   ├── init.py
│   ├── app.py                 # Streamlit dashboard principale
│   ├── components/
│   │   ├── portfolio_view.py  # Vista portfolio
│   │   ├── trades_history.py  # Storico operazioni
│   │   └── equity_curve.py    # Grafico equity curve
│   └── utils.py
│
├── utils/
│   ├── init.py
│   ├── logger.py              # Sistema logging avanzato
│   ├── helpers.py             # Funzioni utility
│   └── validators.py          # Validatori input
│
└── tests/
├── init.py
├── test_indicators.py
├── test_exchange.py
├── test_llm.py
└── test_integration.py

---

## CONFIGURAZIONI E VARIABILI AMBIENTE

### File: .env
Crea template con queste variabili:
```env
# Exchange - Hyperliquid
HYPERLIQUID_API_KEY=your_api_key_here
HYPERLIQUID_SECRET=your_secret_here
HYPERLIQUID_TESTNET=true

# Trading Parameters
TARGET_SYMBOLS=BTC,ETH,SOL
TIMEFRAME=15m
MAX_LEVERAGE=10
DEFAULT_LEVERAGE=3
MAX_POSITION_SIZE_PCT=5.0
MAX_TOTAL_EXPOSURE_PCT=30.0

# LLM - Anthropic
ANTHROPIC_API_KEY=your_anthropic_key_here
MODEL_NAME=claude-opus-4-20250514
LLM_TEMPERATURE=0.3
LLM_MAX_TOKENS=2000

# Database
DATABASE_URL=postgresql://user:password@localhost:5432/trading_agent

# External APIs
COINMARKETCAP_API_KEY=your_cmc_key
NEWS_FEED_URL=https://example.com/crypto-news/feed.xml
WHALE_ALERT_API_KEY=optional_whale_alert_key

# Risk Management
ENABLE_STOP_LOSS=true
ENABLE_TAKE_PROFIT=true
STOP_LOSS_PCT=3.0
TAKE_PROFIT_PCT=5.0
MIN_CONFIDENCE_THRESHOLD=0.6

# Logging
LOG_LEVEL=INFO
LOG_FILE=logs/trading_agent.log

# Dashboard
DASHBOARD_PORT=8501
DASHBOARD_HOST=0.0.0.0
```

### File: config/settings.py
Usa Pydantic per validazione e caricamento sicuro delle configurazioni da .env

---

## SYSTEM PROMPT PER LLM

### File: config/prompts.py

#### SYSTEM PROMPT (Da fornire ad Anthropic)
Sei un trader esperto di criptovalute specializzato in:

Analisi tecnica avanzata
Gestione del rischio rigorosa
Trading con leva finanziaria
Identificazione di trend e pattern

TUO COMPITO:
Analizza i dati di mercato forniti e decidi l'azione di trading ottimale.
Il tuo obiettivo è massimizzare i profitti minimizzando i rischi attraverso decisioni data-driven.

INPUT CHE RICEVERAI:

PORTFOLIO

Saldo USDC disponibile
Posizioni aperte correnti (simbolo, direzione, entry price, PnL)
Equity totale
Esposizione percentuale corrente


DATI DI MERCATO (per ogni simbolo: BTC, ETH, SOL)

Prezzo corrente
Variazione 24h
Volume 24h
Dati OHLCV recenti


INDICATORI TECNICI

MACD (valore, signal line, histogram)
RSI (Relative Strength Index)
EMA20 (Exponential Moving Average 20 periodi)
EMA2 (Exponential Moving Average 2 periodi)
Volume SMA


PIVOT POINTS

PP (Pivot Point centrale)
R1, R2 (Resistenze 1 e 2)
S1, S2 (Supporti 1 e 2)
Distanza percentuale del prezzo corrente dal PP
Flag "near_resistance" e "near_support"


FORECAST PROPHET

Trend previsto (RIALZISTA/RIBASSISTA/LATERALE)
Prezzo target previsto (4 ore avanti)
Variazione percentuale prevista
Livello di confidenza della previsione
Range upper/lower bound


ORDER BOOK

Volume bid totale (top 10 ordini)
Volume ask totale (top 10 ordini)
Ratio bid/ask
Interpretazione: ratio > 1.2 = pressione acquisto, < 0.8 = pressione vendita


SENTIMENT DI MERCATO

Label (FEAR/GREED/NEUTRAL)
Score numerico (0-100, dove 0=extreme fear, 100=extreme greed)
Interpretazione sentiment attuale


NEWS RECENTI

Lista ultime 5 notizie rilevanti
Titolo, sommario, timestamp
Sentiment della notizia (positivo/negativo/neutro)


(OPZIONALE) WHALE ALERT

Grandi transazioni recenti
Direzione flusso capitale




REGOLE DI TRADING (DA SEGUIRE RIGOROSAMENTE):
GESTIONE LEVA:

Leva minima: 1x
Leva massima: {MAX_LEVERAGE}x
Usa leva più alta (7-10x) solo con confidenza > 0.85 e segnali molto forti
Usa leva media (4-6x) con confidenza 0.7-0.85
Usa leva bassa (1-3x) con confidenza 0.6-0.7
NON aprire posizioni con confidenza < 0.6

GESTIONE POSITION SIZE:

Minimo 1% del capitale per posizione
Massimo 5% del capitale per singola posizione
Scala il size in base alla confidenza: alta confidenza = size maggiore

LIMITI DI ESPOSIZIONE:

Mai più del 30% del capitale totale in posizioni aperte contemporaneamente
Se esposizione > 25%, considera solo operazioni ad altissima confidenza
Se già 3 posizioni aperte, sii molto selettivo per la quarta

CONDIZIONI DI ENTRATA (LONG):

RSI < 70 (non overbought)
MACD > MACD Signal (momentum positivo) OPPURE MACD histogram in crescita
Prezzo > EMA20 (trend rialzista) O vicino a supporto S1/S2
Forecast Prophet indica RIALZISTA con confidenza > 0.6
Order book ratio > 1.0 (pressione acquisto)
NON aprire long se prezzo molto vicino a R2 senza forte conferma

CONDIZIONI DI ENTRATA (SHORT):

RSI > 30 (non oversold)
MACD < MACD Signal (momentum negativo) OPPURE MACD histogram in calo
Prezzo < EMA20 (trend ribassista) O vicino a resistenza R1/R2
Forecast Prophet indica RIBASSISTA con confidenza > 0.6
Order book ratio < 1.0 (pressione vendita)
NON aprire short se prezzo molto vicino a S2 senza forte conferma

CONDIZIONI DI CHIUSURA POSIZIONI:

Take profit raggiunto (+5% di default)
Stop loss raggiunto (-3% di default)
Inversione segnali tecnici (es. long aperta ma MACD diventa negativo + RSI >75)
Forecast cambia drasticamente direzione
Sentiment passa da GREED a EXTREME FEAR o viceversa
News molto negative per la crypto in posizione

CONDIZIONI PER HOLD:

Nessun segnale forte in nessuna direzione
Segnali contrastanti (es. MACD positivo ma RSI >75 e forecast negativo)
Confidenza complessiva < 0.6
Già troppa esposizione (>25%)
Mercato laterale confermato da tutti gli indicatori

PESI DI IMPORTANZA INDICATORI (usa questi per valutare):

Pivot Points: 0.8 (molto importante per S/R)
MACD: 0.7 (importante per momentum)
Forecast Prophet: 0.6 (importante per trend)
RSI: 0.7 (importante per overbought/oversold)
Order Book: 0.5 (moderatamente importante)
Sentiment: 0.4 (contesto generale)
News: 0.3 (peso basso, mercato crypto meno reattivo alle news)

RISK MANAGEMENT:

Stop Loss obbligatorio: -3% dal prezzo di entrata (modificabile in caso speciale)
Take Profit obbligatorio: +5% dal prezzo di entrata (modificabile in caso speciale)
In caso di alta volatilità, considera stop loss più stretto (-2%)
In caso di trend molto forte, considera take profit più ampio (+7-10%)


OUTPUT RICHIESTO:
Rispondi ESCLUSIVAMENTE con un JSON valido in questo formato esatto:
{
"action": "open" | "close" | "hold",
"symbol": "BTC" | "ETH" | "SOL",
"direction": "long" | "short" | null,
"leverage": 1-{MAX_LEVERAGE},
"position_size_pct": 1.0-5.0,
"stop_loss_pct": 3.0,
"take_profit_pct": 5.0,
"confidence": 0.0-1.0,
"reasoning": "Spiegazione dettagliata con analisi indicatori, pesi e logica decisionale"
}
REGOLE OUTPUT:

NON includere testo prima o dopo il JSON
NON usare markdown code blocks (```json)
"reasoning" deve essere esaustivo: spiega quali indicatori hanno pesato di più, perché, e come hai combinato i segnali
Se action="hold", direction deve essere null
Se action="close", direction deve essere null
confidence deve riflettere la forza complessiva dei segnali ponderati


#### USER PROMPT TEMPLATE (dinamico con dati)
Crea una funzione che genera il prompt utente inserendo tutti i dati di mercato raccolti in un formato chiaro e leggibile per l'LLM.

---

## DATABASE SCHEMA (PostgreSQL)

### Tabelle da creare:

#### 1. market_contexts
```sql
CREATE TABLE market_contexts (
    id SERIAL PRIMARY KEY,
    symbol VARCHAR(10) NOT NULL,
    timestamp TIMESTAMP NOT NULL,
    price DECIMAL(20, 8) NOT NULL,

    -- Indicatori
    macd DECIMAL(20, 8),
    macd_signal DECIMAL(20, 8),
    macd_histogram DECIMAL(20, 8),
    rsi DECIMAL(10, 4),
    ema20 DECIMAL(20, 8),
    ema2 DECIMAL(20, 8),

    -- Pivot Points
    pivot_pp DECIMAL(20, 8),
    pivot_r1 DECIMAL(20, 8),
    pivot_r2 DECIMAL(20, 8),
    pivot_s1 DECIMAL(20, 8),
    pivot_s2 DECIMAL(20, 8),
    pivot_distance_pct DECIMAL(10, 4),

    -- Forecast
    forecast_trend VARCHAR(20),
    forecast_target_price DECIMAL(20, 8),
    forecast_change_pct DECIMAL(10, 4),
    forecast_confidence DECIMAL(5, 4),

    -- Order Book
    orderbook_bid_volume DECIMAL(20, 8),
    orderbook_ask_volume DECIMAL(20, 8),
    orderbook_ratio DECIMAL(10, 4),

    -- Sentiment
    sentiment_label VARCHAR(20),
    sentiment_score INTEGER,

    -- Raw JSON completo
    raw_data JSONB,

    created_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_market_contexts_symbol_timestamp
ON market_contexts(symbol, timestamp DESC);
```

#### 2. trade_decisions
```sql
CREATE TABLE trade_decisions (
    id SERIAL PRIMARY KEY,
    context_id INTEGER REFERENCES market_contexts(id),
    symbol VARCHAR(10) NOT NULL,
    timestamp TIMESTAMP NOT NULL,

    -- Decisione LLM
    action VARCHAR(10) NOT NULL, -- open, close, hold
    direction VARCHAR(10), -- long, short, null
    leverage INTEGER,
    position_size_pct DECIMAL(10, 4),
    stop_loss_pct DECIMAL(10, 4),
    take_profit_pct DECIMAL(10, 4),
    confidence DECIMAL(5, 4),
    reasoning TEXT,

    -- Esecuzione
    execution_status VARCHAR(20), -- pending, executed, failed, skipped
    execution_details JSONB,
    execution_timestamp TIMESTAMP,

    -- Entry details (se aperta)
    entry_price DECIMAL(20, 8),
    entry_quantity DECIMAL(20, 8),
    order_id VARCHAR(100),

    created_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_trade_decisions_symbol_timestamp
ON trade_decisions(symbol, timestamp DESC);
```

#### 3. positions
```sql
CREATE TABLE positions (
    id SERIAL PRIMARY KEY,
    symbol VARCHAR(10) NOT NULL,
    direction VARCHAR(10) NOT NULL,

    -- Entry
    entry_timestamp TIMESTAMP NOT NULL,
    entry_price DECIMAL(20, 8) NOT NULL,
    quantity DECIMAL(20, 8) NOT NULL,
    leverage INTEGER NOT NULL,
    entry_trade_id INTEGER REFERENCES trade_decisions(id),

    -- Exit
    exit_timestamp TIMESTAMP,
    exit_price DECIMAL(20, 8),
    exit_reason VARCHAR(50), -- take_profit, stop_loss, manual, signal_reversal
    exit_trade_id INTEGER REFERENCES trade_decisions(id),

    -- P&L
    realized_pnl DECIMAL(20, 8),
    realized_pnl_pct DECIMAL(10, 4),

    -- Status
    status VARCHAR(20) DEFAULT 'open', -- open, closed

    -- Stop Loss & Take Profit
    stop_loss_price DECIMAL(20, 8),
    take_profit_price DECIMAL(20, 8),

    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_positions_symbol_status
ON positions(symbol, status);
```

#### 4. portfolio_snapshots
```sql
CREATE TABLE portfolio_snapshots (
    id SERIAL PRIMARY KEY,
    timestamp TIMESTAMP NOT NULL,

    -- Balances
    total_equity_usdc DECIMAL(20, 8) NOT NULL,
    available_balance_usdc DECIMAL(20, 8) NOT NULL,
    margin_used_usdc DECIMAL(20, 8),

    -- Positions summary
    open_positions_count INTEGER,
    total_exposure_pct DECIMAL(10, 4),

    -- Performance
    total_pnl_usdc DECIMAL(20, 8),
    total_pnl_pct DECIMAL(10, 4),

    -- Raw data
    raw_portfolio JSONB,

    created_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_portfolio_snapshots_timestamp
ON portfolio_snapshots(timestamp DESC);
```

#### 5. news_events
```sql
CREATE TABLE news_events (
    id SERIAL PRIMARY KEY,
    title TEXT NOT NULL,
    summary TEXT,
    source VARCHAR(100),
    url TEXT,
    published_at TIMESTAMP,
    sentiment VARCHAR(20), -- positive, negative, neutral
    relevance_score DECIMAL(5, 4),
    symbols TEXT[], -- Array di simboli rilevanti
    raw_data JSONB,
    created_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_news_events_published
ON news_events(published_at DESC);
```

---

## LOGICA CORE DELL'AGENTE

### File: core/agent.py

L'agente deve implementare questo flusso:

**CICLO PRINCIPALE (ogni 15 minuti):**

1. **INIZIALIZZAZIONE**
   - Carica configurazioni
   - Connetti a exchange (Hyperliquid via CCXT)
   - Connetti a database
   - Verifica connessioni API esterne

2. **PER OGNI SIMBOLO (BTC, ETH, SOL):**

   A. **RACCOLTA DATI**
      - Fetch ticker corrente da exchange
      - Fetch OHLCV ultimi 200 candles (timeframe 15m)
      - Fetch portfolio (balance, posizioni aperte)
      - Fetch order book (top 10 bid/ask)
      - Fetch sentiment da CoinMarketCap (cache 1h)
      - Fetch news feed XML (cache 30min)
      - (Opzionale) Fetch whale alerts

   B. **CALCOLO INDICATORI**
      - Calcola MACD, RSI, EMA20, EMA2 usando pandas
      - Calcola Pivot Points (PP, R1, R2, S1, S2)
      - Esegui forecast Prophet (4 ore avanti)
      - Calcola volumi order book

   C. **SALVATAGGIO CONTESTO**
      - Inserisci in `market_contexts` tutti i dati raccolti
      - Ottieni `context_id` per riferimento

   D. **DECISIONE LLM**
      - Costruisci prompt completo con tutti i dati
      - Chiama Anthropic API (Claude Opus 4)
      - Imposta temperature=0.3 per decisioni più conservative
      - Parse risposta JSON

   E. **VALIDAZIONE DECISIONE**
      - Verifica formato JSON corretto
      - Controlla che leverage <= MAX_LEVERAGE
      - Controlla che position_size <= MAX_POSITION_SIZE_PCT
      - Controlla che confidence >= MIN_CONFIDENCE_THRESHOLD
      - Controlla esposizione totale <= MAX_TOTAL_EXPOSURE_PCT
      - Se validazione fallisce: registra come "skipped" e vai avanti

   F. **ESECUZIONE**
      - Se action="hold": logga e continua
      - Se action="close": chiudi posizione esistente via exchange
      - Se action="open": apri nuova posizione con leverage e size specificati, imposta stop loss e take profit
      - Gestisci errori exchange (insufficient funds, invalid order, ecc.)
      - Salva esito in `trade_decisions`

   G. **POST-ESECUZIONE**
      - Se posizione aperta: crea record in `positions`
      - Se posizione chiusa: aggiorna record in `positions` con exit details e P&L
      - Crea snapshot portfolio in `portfolio_snapshots`

3. **FINE CICLO**
   - Log riassunto operazioni
   - Pulisci cache obsolete
   - Chiudi connessioni
   - Exit clean

**GESTIONE ERRORI:**
- Try/catch su ogni operazione critica
- Log errori con stack trace completo
- In caso di errore LLM: default a "hold"
- In caso di errore exchange: retry con backoff esponenziale (max 3 tentativi)
- In caso di errore DB: log su file e continua (non bloccare trading)

---

## INDICATORI - SPECIFICHE DI CALCOLO

### File: indicators/technical.py

**MACD (Moving Average Convergence Divergence):**
- Fast period: 12
- Slow period: 26
- Signal period: 9
- Formula: MACD = EMA(12) - EMA(26)
- Signal Line = EMA(9) of MACD
- Histogram = MACD - Signal Line
- Usa pandas `.ewm()` per calcolo

**RSI (Relative Strength Index):**
- Period: 14
- Formula standard: RSI = 100 - (100 / (1 + RS))
- RS = Average Gain / Average Loss su 14 periodi
- Valori: 0-100
- Overbought: >70
- Oversold: <30

**EMA (Exponential Moving Average):**
- EMA20: 20 periodi
- EMA2: 2 periodi
- Usa pandas `.ewm(span=n, adjust=False).mean()`

**Volume SMA:**
- Simple Moving Average del volume su 20 periodi

### File: indicators/pivot_points.py

**Pivot Points (Standard Method):**
- Usa ultima candela completata per calcolo
- PP = (High + Low + Close) / 3
- R1 = 2 * PP - Low
- R2 = PP + (High - Low)
- S1 = 2 * PP - High
- S2 = PP - (High - Low)
- Calcola distanza percentuale: ((Current Price - PP) / PP) * 100
- Flag "near_resistance" se prezzo > R1 * 0.99
- Flag "near_support" se prezzo < S1 * 1.01

### File: indicators/forecasting.py

**Prophet Forecasting:**
- Input: DataFrame con columns ['ds', 'y'] dove ds=timestamp, y=close price
- Addestra su tutti i dati OHLCV disponibili (200 candles)
- Forecast: 16 periodi avanti (4 ore con timeframe 15min)
- Estrai: yhat (previsione), yhat_lower, yhat_upper (confidence interval)
- Calcola trend:
  - Se change > +1%: "RIALZISTA"
  - Se change < -1%: "RIBASSISTA"
  - Altrimenti: "LATERALE"
- Confidenza = 1 - ((yhat_upper - yhat_lower) / yhat) / 2

**Cache modelli:**
- Mantieni un modello Prophet per simbolo in memoria
- Ri-addestra ogni 1 ora o ogni 50 cicli
- Salva modelli su disco (pickle) per persistenza

---

## EXCHANGE INTEGRATION

### File: exchange/hyperliquid_client.py

**Setup CCXT:**
```python
import ccxt

exchange = ccxt.hyperliquid({
    'apiKey': settings.HYPERLIQUID_API_KEY,
    'secret': settings.HYPERLIQUID_SECRET,
    'options': {
        'defaultType': 'swap',  # Perpetual futures
        'testnet': settings.HYPERLIQUID_TESTNET
    }
})
```

**Metodi da implementare:**

1. **fetch_ticker(symbol)** -> dict
   - Ritorna: last price, bid, ask, volume 24h, change 24h

2. **fetch_ohlcv(symbol, timeframe, limit)** -> List[List]
   - Ritorna candele OHLCV
   - Format: [[timestamp, open, high, low, close, volume], ...]

3. **fetch_portfolio()** -> dict
   - Ritorna: total_equity, available_balance, margin_used, positions[]

4. **fetch_order_book(symbol, limit=10)** -> dict
   - Ritorna: bids[[price, amount], ...], asks[[price, amount], ...]

5. **open_position(symbol, direction, size_pct, leverage, stop_loss_pct, take_profit_pct)** -> dict
   - Calcola quantity da size_pct e balance
   - Imposta leverage
   - Crea market order (buy se long, sell se short)
   - Imposta stop loss e take profit come ordini condizionali
   - Ritorna: order_id, entry_price, quantity, timestamp

6. **close_position(symbol)** -> dict
   - Trova posizione aperta per symbol
   - Crea ordine inverso per chiudere
   - Cancella stop loss e take profit
   - Ritorna: exit_price, pnl, timestamp

7. **get_total_exposure()** -> float
   - Calcola somma (position_value / total_equity) per tutte posizioni aperte
   - Ritorna valore 0.0-1.0 (0-100%)

**Gestione errori exchange:**
- InsufficientFunds: logga e salta operazione
- InvalidOrder: logga parametri e salta
- NetworkError: retry con exponential backoff
- RateLimitExceeded: wait e retry

---

## DATI ESTERNI

### File: data/sentiment.py

**CoinMarketCap Fear & Greed Index:**
- Endpoint: https://pro-api.coinmarketcap.com/v3/fear-and-greed/latest
- Headers: X-CMC_PRO_API_KEY
- Response: { value: 0-100, classification: "Extreme Fear"|"Fear"|"Neutral"|"Greed"|"Extreme Greed" }
- Cache: 1 ora (il sentiment non cambia ogni 15 minuti)

**Mapping:**
- 0-25: "FEAR"
- 26-45: "NEUTRAL"
- 46-100: "GREED"

### File: data/news_feed.py

**XML News Feed Parser:**
- Parse RSS/Atom feed da URL configurato
- Estrai: title, link, pubDate, description
- Filtra per keywords crypto: ["bitcoin", "btc", "ethereum", "eth", "solana", "sol", "crypto", "blockchain"]
- Analizza sentiment del titolo (usa libreria VADER o TextBlob)
- Cache: 30 minuti
- Ritorna: List[dict] ordinato per data decrescente

### File: data/whale_alert.py (Opzionale)

**Whale Alert API:**
- Endpoint: https://api.whale-alert.io/v1/transactions
- Parametri: api_key, min_value (es. 1000000 USD), limit
- Filtra per blockchain: ethereum, bitcoin
- Estrai: from/to, amount, timestamp, blockchain
- Cache: 15 minuti

---

## GESTIONE RISCHIO

### File: core/risk_manager.py

**Validazioni pre-trade:**

1. **check_leverage(leverage)** -> bool
   - Ritorna True se leverage <= MAX_LEVERAGE

2. **check_position_size(size_pct, balance)** -> bool
   - Ritorna True se size_pct <= MAX_POSITION_SIZE_PCT
   - Verifica anche che size_pct * balance >= minimum_order_size

3. **check_total_exposure(new_position_value, current_exposure)** -> bool
   - Calcola: new_exposure = current_exposure + (new_position_value / total_equity)
   - Ritorna True se new_exposure <= MAX_TOTAL_EXPOSURE_PCT

4. **check_confidence(confidence)** -> bool
   - Ritorna True se confidence >= MIN_CONFIDENCE_THRESHOLD

5. **calculate_stop_loss_price(entry_price, direction, stop_loss_pct)** -> float
   - Se long: entry_price * (1 - stop_loss_pct/100)
   - Se short: entry_price * (1 + stop_loss_pct/100)

6. **calculate_take_profit_price(entry_price, direction, take_profit_pct)** -> float
   - Se long: entry_price * (1 + take_profit_pct/100)
   - Se short: entry_price * (1 - take_profit_pct/100)

**Filtro decisioni LLM:**
- Se LLM suggerisce azione non valida: override a "hold"
- Se parametri fuori range: clamp ai limiti (es. leverage 15 -> 10)
- Logga sempre quando una decisione viene filtrata/modificata

---

## DASHBOARD STREAMLIT

### File: dashboard/app.py

**Pagine da creare:**

1. **Overview**
   - Equity curve (grafico linea temporale)
   - Portfolio corrente (balance, positions, exposure)
   - Statistiche generali: total trades, win rate, total P&L
   - Ultime 10 operazioni in tabella

2. **Positions**
   - Tabella posizioni aperte: symbol, direction, entry price, current price, P&L, leverage
   - Grafico P&L per posizione
   - Bottone "Close Manual" per chiusura manuale emergenza

3. **Trades History**
   - Tabella tutte le operazioni: symbol, action, timestamp, price, P&L, reasoning
   - Filtri: symbol, date range, action type
   - Export CSV

4. **Market Analysis**
   - Grafici candlestick per BTC/ETH/SOL
   - Overlay indicatori (MACD, RSI, EMA, Pivot Points)
   - Forecast Prophet visualizzato

5. **Agent Decisions**
   - Log decisioni LLM in real-time
   - Confidence score per operazione
   - Reasoning completo
   - Indicatori usati per quella decisione

6. **Settings**
   - Form per modificare parametri (leverage, stop loss, take profit)
   - Toggle enable/disable agent
   - Force manual cycle trigger

**Auto-refresh:**
- Imposta st.rerun() ogni 60 secondi per aggiornare dati

---

## DEPLOYMENT RAILWAY

### File: railway.json
```json
{
  "$schema": "https://railway.app/railway.schema.json",
  "build": {
    "builder": "NIXPACKS"
  },
  "deploy": {
    "startCommand": "python main.py",
    "restartPolicyType": "ON_FAILURE",
    "restartPolicyMaxRetries": 3
  }
}
```

**Cron Job Setup:**
- Usa Railway Cron Jobs
- Schedule: "*/15 * * * *" (ogni 15 minuti)
- Command: python main.py
- Timezone: UTC

**Environment Variables:**
- Imposta tutte le variabili .env su Railway dashboard
- Usa Railway PostgreSQL plugin per DATABASE_URL

---

## LOGGING

### File: utils/logger.py

**Configurazione logging:**
- Level: INFO (configurabile via env)
- Format: [%(asctime)s] [%(levelname)s] [%(name)s] %(message)s
- Handlers:
  - Console (stdout) con colori
  - File rotating (logs/trading_agent.log, max 10MB, keep 10 files)

**Cosa loggare:**
- INFO: Inizio/fine ciclo, decisioni, esecuzioni
- WARNING: Validazioni fallite, retry
- ERROR: Eccezioni, errori API
- DEBUG: Dati raw, dettagli calcoli (solo se LOG_LEVEL=DEBUG)

---

## TESTING

### Testnet Prima di Mainnet
- HYPERLIQUID_TESTNET=true di default
- Testare per almeno 1 settimana su testnet
- Monitorare equity curve, win rate, max drawdown
- Identificare bugs e comportamenti anomali

### Unit Tests
- test_indicators.py: Verifica calcolo MACD, RSI, EMA, Pivot Points
- test_exchange.py: Mock CCXT, verifica logica order management
- test_llm.py: Mock Anthropic API, verifica parsing JSON
- test_risk_manager.py: Verifica tutte le validazioni

### Integration Tests
- test_integration.py: Simula ciclo completo end-to-end
- Usa dati storici reali
- Verifica che DB viene popolato correttamente

---

## OTTIMIZZAZIONI FUTURE (FASE 2)

Queste feature NON vanno implementate subito, ma documentale per evoluzione futura:

1. **Sistema Multi-Agente**
   - Agente "Strategist" a bassa frequenza (weekly) per direzione generale
   - Agente "Trader" ad alta frequenza (15min) per esecuzione

2. **Backtesting Engine**
   - Replay dati storici
   - Valutare performance strategie alternative
   - Ottimizzazione parametri

3. **Ottimizzazione Pesi Indicatori**
   - Algoritmo genetico o grid search per trovare pesi ottimali
   - Test su dati out-of-sample

4. **Multiple LLM Comparison**
   - Supporto GPT, Gemini, Claude in parallelo
   - Confronta strategie di diversi modelli
   - Ensemble voting per decisioni

5. **Advanced Risk Management**
   - Dynamic position sizing (Kelly Criterion)
   - Correlation analysis tra posizioni
   - Maximum drawdown limiter

6. **Paper Trading Mode**
   - Modalità simulazione senza esecuzione reale
   - Per testing nuove strategie

---

## PRIORITÀ IMPLEMENTAZIONE

**FASE 1 - MVP (Implementa subito):**
1. Setup progetto, config, requirements.txt
2. Database schema e migrations
3. Exchange client (CCXT wrapper)
4. Indicatori tecnici (MACD, RSI, EMA, Pivot Points)
5. LLM client (Anthropic)
6. Agent core loop
7. Basic logging
8. Testnet deployment

**FASE 2 - Completamento (dopo testing MVP):**
9. Prophet forecasting
10. Sentiment API integration
11. News feed parser
12. Risk manager avanzato
13. Dashboard Streamlit
14. Full testing suite

**FASE 3 - Produzione:**
15. Mainnet deployment (capitale reale ridotto)
16. Monitoring e alerts
17. Backup automatici DB
18. Error recovery automatico

---

## NOTE IMPORTANTI

1. **Security:**
   - MAI committare API keys
   - Usa .env per tutte le secrets
   - .gitignore: .env, logs/, *.pyc, __pycache__

2. **Error Handling:**
   - Ogni chiamata API deve essere in try/except
   - Log stack trace completo
   - Graceful degradation (default a HOLD in caso errore)

3. **Performance:**
   - Cache API calls (sentiment, news)
   - Riusa connessioni database
   - Async dove possibile (aiohttp per API)

4. **Manutenzione:**
   - README.md dettagliato con setup instructions
   - Docstrings in ogni funzione
   - Type hints Python ovunque
   - Comments per logiche complesse

5. **Monitoraggio:**
   - Log ogni decisione e reasoning
   - Salva tutto nel DB per analisi post-mortem
   - Alert se equity scende >10% in 24h

---

## DELIVERABLES FINALI

Alla fine dell'implementazione, devo avere:

✅ Progetto Python funzionante con struttura directory completa
✅ File requirements.txt con tutte le dipendenze
✅ File .env.example documentato
✅ Database PostgreSQL con schema completo
✅ Agent che si sveglia ogni 15 minuti e opera autonomamente
✅ Integration con Hyperliquid via CCXT
✅ LLM decisionale via Anthropic API
✅ Sistema logging robusto
✅ Dashboard Streamlit per monitoring
✅ Test su Hyperliquid Testnet funzionanti
✅ README.md con istruzioni complete setup e deploy
✅ Codice commentato e type-hinted
✅ Gestione errori completa

---

## ESEMPIO FLUSSO COMPLETO

Un ciclo tipico dovrebbe essere:
[12:00:00] === Inizio Ciclo Trading ===
[12:00:01] Connesso a Hyperliquid Testnet
[12:00:02] Analizzando BTC...
[12:00:03] - Prezzo: $45,230.50
[12:00:03] - RSI: 58.3 | MACD: +12.4 | Forecast: RIALZISTA (+2.3%)
[12:00:04] - Chiamata LLM per decisione...
[12:00:06] - LLM Decision: OPEN LONG | Leverage: 4x | Confidence: 0.78
[12:00:06] - Validazione: PASSED
[12:00:07] - Apertura posizione: BTC LONG @ $45,230.50 | Size: 3.5% | Leverage: 4x
[12:00:08] - Stop Loss: $43,873.78 (-3%) | Take Profit: $47,491.02 (+5%)
[12:00:08] - Order ID: 7d8f9a2b | Status: EXECUTED
[12:00:09] - Salvato in database: context_id=1542, trade_id=987
[12:00:10] Analizzando ETH...
[12:00:11] - Prezzo: $2,834.20
[12:00:11] - RSI: 72.1 | MACD: -5.2 | Forecast: LATERALE (+0.1%)
[12:00:12] - Chiamata LLM per decisione...
[12:00:14] - LLM Decision: HOLD | Confidence: 0.52 | Reasoning: "Segnali contrastanti..."
[12:00:14] - Nessuna azione per ETH
[12:00:15] Analizzando SOL...
[12:00:16] - Prezzo: $98.45
[12:00:16] - RSI: 45.2 | MACD: +3.1 | Forecast: RIALZISTA (+1.8%)
[12:00:17] - Esposizione totale: 28.5% (limite 30%)
[12:00:17] - Chiamata LLM per decisione...
[12:00:19] - LLM Decision: HOLD | Confidence: 0.68 | Reasoning: "Segnali positivi ma esposizione già alta"
[12:00:19] - Nessuna azione per SOL
[12:00:20] Portfolio Snapshot salvato
[12:00:20] === Ciclo Completato ===
[12:00:20] Prossimo ciclo: 12:15:00

---
